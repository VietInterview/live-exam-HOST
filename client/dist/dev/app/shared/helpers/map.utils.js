"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("./reflect");
var decorator_1 = require("../models/decorator");
var moment = require("moment");
var constants_1 = require("../models/constants");
var decorator_2 = require("../models/decorator");
var MapUtils = (function () {
    function MapUtils() {
    }
    MapUtils.isPrimitive = function (obj) {
        switch (typeof obj) {
            case "string":
            case "number":
            case "boolean":
                return true;
        }
        return !!(obj instanceof String || obj === String ||
            obj instanceof Number || obj === Number ||
            obj instanceof Boolean || obj === Boolean);
    };
    MapUtils.isDate = function (clazz) {
        return (clazz instanceof Date);
    };
    MapUtils.isArray = function (object) {
        if (object === Array) {
            return true;
        }
        else if (typeof Array.isArray === "function") {
            return Array.isArray(object);
        }
        else {
            return !!(object instanceof Array);
        }
    };
    MapUtils.getClazz = function (target, propertyKey) {
        return Reflect.getMetadata("design:type", target, propertyKey);
    };
    MapUtils.getFieldProperty = function (target, propertyKey) {
        return Reflect.getMetadata(decorator_1.FIELD_METADATA_KEY, target, propertyKey);
    };
    MapUtils.getLocalProperty = function (target, propertyKey) {
        return Reflect.getMetadata(decorator_1.FIELD_METADATA_KEY, target, propertyKey);
    };
    MapUtils.deserialize = function (clazz, jsonObject) {
        if ((clazz === undefined) || (jsonObject === undefined))
            return undefined;
        var obj = new clazz();
        Object.keys(obj).forEach(function (key) {
            var propertyMetadataFn = function (propertyMetadata) {
                var propertyName = propertyMetadata.name || key;
                var innerJson = jsonObject ? jsonObject[propertyName] : undefined;
                var clazz = MapUtils.getClazz(obj, key);
                if (!jsonObject[propertyName])
                    return null;
                if (MapUtils.isArray(clazz)) {
                    var metadata_1 = MapUtils.getLocalProperty(obj, key);
                    if (metadata_1.clazz || MapUtils.isPrimitive(clazz)) {
                        if (innerJson && MapUtils.isArray(innerJson)) {
                            return innerJson.map(function (item) { return MapUtils.deserialize(metadata_1.clazz, item); });
                        }
                        else {
                            return undefined;
                        }
                    }
                    else {
                        return innerJson;
                    }
                }
                else if (MapUtils.isPrimitive(clazz)) {
                    return jsonObject ? jsonObject[propertyName] : undefined;
                }
                else if (MapUtils.isDate(new clazz())) {
                    return jsonObject ? moment(jsonObject[propertyName], constants_1.SERVER_DATETIME_FORMAT).toDate() : undefined;
                }
                else {
                    return MapUtils.deserialize(clazz, innerJson);
                }
            };
            var propertyMetadata = MapUtils.getFieldProperty(obj, key);
            if (propertyMetadata) {
                obj[key] = propertyMetadataFn(propertyMetadata);
            }
            else {
                if (jsonObject && jsonObject[key] !== undefined) {
                    obj[key] = jsonObject[key];
                }
            }
        });
        return obj;
    };
    MapUtils.deserializeModel = function (model, jsonObject) {
        if (jsonObject === undefined)
            return undefined;
        var obj = decorator_2.ModelRegister.Instance.instantiateObject(model);
        Object.keys(obj).forEach(function (key) {
            var propertyMetadataFn = function (propertyMetadata) {
                var propertyName = propertyMetadata.name || key;
                var innerJson = jsonObject ? jsonObject[propertyName] : undefined;
                var clazz = MapUtils.getClazz(obj, key);
                if (!jsonObject[propertyName])
                    return null;
                if (MapUtils.isPrimitive(clazz)) {
                    return jsonObject ? jsonObject[propertyName] : undefined;
                }
                else if (MapUtils.isDate(new clazz())) {
                    return jsonObject ? moment(jsonObject[propertyName], constants_1.SERVER_DATETIME_FORMAT).toDate() : undefined;
                }
            };
            var propertyMetadata = MapUtils.getFieldProperty(obj, key);
            if (propertyMetadata) {
                obj[key] = propertyMetadataFn(propertyMetadata);
            }
            else {
                if (jsonObject && jsonObject[key] !== undefined) {
                    obj[key] = jsonObject[key];
                }
            }
        });
        return obj;
    };
    MapUtils.serialize = function (object) {
        if (object === undefined)
            return {};
        var jsonObject = {};
        Object.keys(object).forEach(function (key) {
            if (MapUtils.isDate(object[key]))
                jsonObject[key] = moment(object[key]).format(constants_1.SERVER_DATETIME_FORMAT);
            else
                jsonObject[key] = object[key];
        });
        return jsonObject;
    };
    return MapUtils;
}());
exports.MapUtils = MapUtils;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvaGVscGVycy9tYXAudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQkFBbUI7QUFDbkIsaURBQXVGO0FBQ3ZGLCtCQUFpQztBQUNqQyxpREFBMkQ7QUFDM0QsaURBQW9EO0FBRXBEO0lBQUE7SUE4SEEsQ0FBQztJQTdIVSxvQkFBVyxHQUFsQixVQUFtQixHQUFPO1FBQ3RCLE1BQU0sQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNqQixLQUFLLFFBQVEsQ0FBQztZQUNkLEtBQUssUUFBUSxDQUFDO1lBQ2QsS0FBSyxTQUFTO2dCQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDcEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFlBQVksTUFBTSxJQUFJLEdBQUcsS0FBSyxNQUFNO1lBQ2pELEdBQUcsWUFBWSxNQUFNLElBQUksR0FBRyxLQUFLLE1BQU07WUFDdkMsR0FBRyxZQUFZLE9BQU8sSUFBSSxHQUFHLEtBQUssT0FBTyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVNLGVBQU0sR0FBYixVQUFjLEtBQVM7UUFDbkIsTUFBTSxDQUFDLENBQUMsS0FBSyxZQUFZLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTSxnQkFBTyxHQUFkLFVBQWUsTUFBVTtRQUNyQixFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLENBQUMsT0FBTyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDN0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUNELElBQUksQ0FBQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sWUFBWSxLQUFLLENBQUMsQ0FBQztRQUN2QyxDQUFDO0lBQ0wsQ0FBQztJQUVNLGlCQUFRLEdBQWYsVUFBZ0IsTUFBVyxFQUFFLFdBQW1CO1FBQ2xELE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDL0QsQ0FBQztJQUVNLHlCQUFnQixHQUF2QixVQUEyQixNQUFXLEVBQUUsV0FBbUI7UUFDMUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsOEJBQWtCLEVBQUUsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFUyx5QkFBZ0IsR0FBdkIsVUFBMkIsTUFBVyxFQUFFLFdBQW1CO1FBQ3ZELE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLDhCQUFrQixFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRU0sb0JBQVcsR0FBbEIsVUFBc0IsS0FBZ0IsRUFBRSxVQUFjO1FBQ2xELEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUMxRSxJQUFJLEdBQUcsR0FBTyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBRztZQUN6QixJQUFJLGtCQUFrQixHQUEyQixVQUFDLGdCQUFnQjtnQkFDOUQsSUFBSSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQztnQkFDaEQsSUFBSSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQkFDbEUsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUNoQixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUIsSUFBSSxVQUFRLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDbkQsRUFBRSxDQUFDLENBQUMsVUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDaEQsRUFBRSxDQUFDLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUMzQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FDaEIsVUFBQyxJQUFRLElBQUksT0FBQSxRQUFRLENBQUMsV0FBVyxDQUFDLFVBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQTFDLENBQTBDLENBQzFELENBQUM7d0JBQ04sQ0FBQzt3QkFBQyxJQUFJLENBQUMsQ0FBQzs0QkFDSixNQUFNLENBQUMsU0FBUyxDQUFDO3dCQUNyQixDQUFDO29CQUNMLENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ0osTUFBTSxDQUFDLFNBQVMsQ0FBQztvQkFDckIsQ0FBQztnQkFFTCxDQUFDO2dCQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDckMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQzdELENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdEMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsRUFBQyxrQ0FBc0IsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFBLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ3BHLENBQUM7Z0JBQ0EsSUFBSSxDQUFDLENBQUM7b0JBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUNsRCxDQUFDO1lBQ0wsQ0FBQyxDQUFDO1lBRUYsSUFBSSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzNELEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztnQkFDbkIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDcEQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztvQkFDOUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0IsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDZixDQUFDO0lBRU0seUJBQWdCLEdBQXZCLFVBQXdCLEtBQVksRUFBRSxVQUFjO1FBQ2hELEVBQUUsQ0FBQyxDQUFDLFVBQVUsS0FBSyxTQUFTLENBQUM7WUFBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1FBQy9DLElBQUksR0FBRyxHQUFPLHlCQUFhLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBRztZQUN6QixJQUFJLGtCQUFrQixHQUEyQixVQUFDLGdCQUFnQjtnQkFDOUQsSUFBSSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQztnQkFDaEQsSUFBSSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQkFDbEUsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUNoQixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDOUIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQzdELENBQUM7Z0JBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdEMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsRUFBQyxrQ0FBc0IsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFBLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ3BHLENBQUM7WUFDTCxDQUFDLENBQUM7WUFFRixJQUFJLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDM0QsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO2dCQUNuQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNwRCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO29CQUM5QyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQixDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFFTSxrQkFBUyxHQUFoQixVQUFpQixNQUFVO1FBQ3ZCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUM7WUFBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ3BDLElBQUksVUFBVSxHQUFPLEVBQUUsQ0FBQztRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEdBQUc7WUFDNUIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsa0NBQXNCLENBQUMsQ0FBQztZQUN6RSxJQUFJO2dCQUNBLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDO0lBQ3RCLENBQUM7SUFDTCxlQUFDO0FBQUQsQ0E5SEEsQUE4SEMsSUFBQTtBQTlIWSw0QkFBUSIsImZpbGUiOiJhcHAvc2hhcmVkL2hlbHBlcnMvbWFwLnV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuL3JlZmxlY3QnO1xuaW1wb3J0IHsgRklFTERfTUVUQURBVEFfS0VZLCBGaWVsZFByb3BlcnR5LCBJRmllbGRNZXRhRGF0YSB9IGZyb20gJy4uL21vZGVscy9kZWNvcmF0b3InXG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7U0VSVkVSX0RBVEVUSU1FX0ZPUk1BVH0gZnJvbSAnLi4vbW9kZWxzL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBNb2RlbFJlZ2lzdGVyIH0gZnJvbSAnLi4vbW9kZWxzL2RlY29yYXRvcic7XG5cbmV4cG9ydCBjbGFzcyBNYXBVdGlscyB7XG4gICAgc3RhdGljIGlzUHJpbWl0aXZlKG9iajphbnkpIHtcbiAgICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7XG4gICAgICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhIShvYmogaW5zdGFuY2VvZiBTdHJpbmcgfHwgb2JqID09PSBTdHJpbmcgfHxcbiAgICAgICAgb2JqIGluc3RhbmNlb2YgTnVtYmVyIHx8IG9iaiA9PT0gTnVtYmVyIHx8XG4gICAgICAgIG9iaiBpbnN0YW5jZW9mIEJvb2xlYW4gfHwgb2JqID09PSBCb29sZWFuKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaXNEYXRlKGNsYXp6OmFueSkge1xuICAgICAgICByZXR1cm4gKGNsYXp6IGluc3RhbmNlb2YgRGF0ZSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGlzQXJyYXkob2JqZWN0OmFueSkge1xuICAgICAgICBpZiAob2JqZWN0ID09PSBBcnJheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEFycmF5LmlzQXJyYXkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkob2JqZWN0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAhIShvYmplY3QgaW5zdGFuY2VvZiBBcnJheSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0Q2xhenoodGFyZ2V0OiBhbnksIHByb3BlcnR5S2V5OiBzdHJpbmcpOiBhbnkge1xuXHRcdHJldHVybiBSZWZsZWN0LmdldE1ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgdGFyZ2V0LCBwcm9wZXJ0eUtleSlcblx0fVxuXG5cdHN0YXRpYyBnZXRGaWVsZFByb3BlcnR5PFQ+KHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogc3RyaW5nKTogIElGaWVsZE1ldGFEYXRhPFQ+IHtcblx0XHRyZXR1cm4gUmVmbGVjdC5nZXRNZXRhZGF0YShGSUVMRF9NRVRBREFUQV9LRVksIHRhcmdldCwgcHJvcGVydHlLZXkpO1xuXHR9XG5cbiAgICBzdGF0aWMgZ2V0TG9jYWxQcm9wZXJ0eTxUPih0YXJnZXQ6IGFueSwgcHJvcGVydHlLZXk6IHN0cmluZyk6ICBJRmllbGRNZXRhRGF0YTxUPiB7XG4gICAgICAgIHJldHVybiBSZWZsZWN0LmdldE1ldGFkYXRhKEZJRUxEX01FVEFEQVRBX0tFWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGRlc2VyaWFsaXplPFQ+KGNsYXp6OntuZXcoKTogVH0sIGpzb25PYmplY3Q6YW55KSB7XG4gICAgICAgIGlmICgoY2xhenogPT09IHVuZGVmaW5lZCkgfHwgKGpzb25PYmplY3QgPT09IHVuZGVmaW5lZCkpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBvYmo6YW55ID0gbmV3IGNsYXp6KCk7XG4gICAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBsZXQgcHJvcGVydHlNZXRhZGF0YUZuOihJRmllbGRNZXRhRGF0YSkgPT4gYW55ID0gKHByb3BlcnR5TWV0YWRhdGEpPT4ge1xuICAgICAgICAgICAgICAgIGxldCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eU1ldGFkYXRhLm5hbWUgfHwga2V5O1xuICAgICAgICAgICAgICAgIGxldCBpbm5lckpzb24gPSBqc29uT2JqZWN0ID8ganNvbk9iamVjdFtwcm9wZXJ0eU5hbWVdIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIGxldCBjbGF6eiA9IE1hcFV0aWxzLmdldENsYXp6KG9iaiwga2V5KTtcbiAgICAgICAgICAgICAgICBpZiAoIWpzb25PYmplY3RbcHJvcGVydHlOYW1lXSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgaWYgKE1hcFV0aWxzLmlzQXJyYXkoY2xhenopKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBtZXRhZGF0YSA9IE1hcFV0aWxzLmdldExvY2FsUHJvcGVydHkob2JqLCBrZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWV0YWRhdGEuY2xhenogfHwgTWFwVXRpbHMuaXNQcmltaXRpdmUoY2xhenopKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5uZXJKc29uICYmIE1hcFV0aWxzLmlzQXJyYXkoaW5uZXJKc29uKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbm5lckpzb24ubWFwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaXRlbTphbnkpPT4gTWFwVXRpbHMuZGVzZXJpYWxpemUobWV0YWRhdGEuY2xhenosIGl0ZW0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbm5lckpzb247XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoTWFwVXRpbHMuaXNQcmltaXRpdmUoY2xhenopKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uT2JqZWN0ID8ganNvbk9iamVjdFtwcm9wZXJ0eU5hbWVdIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoTWFwVXRpbHMuaXNEYXRlKG5ldyBjbGF6eigpKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbk9iamVjdCA/IG1vbWVudChqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0sU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCkudG9EYXRlKCk6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gTWFwVXRpbHMuZGVzZXJpYWxpemUoY2xhenosIGlubmVySnNvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHByb3BlcnR5TWV0YWRhdGEgPSBNYXBVdGlscy5nZXRGaWVsZFByb3BlcnR5KG9iaiwga2V5KTtcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0eU1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU1ldGFkYXRhRm4ocHJvcGVydHlNZXRhZGF0YSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChqc29uT2JqZWN0ICYmIGpzb25PYmplY3Rba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIG9ialtrZXldID0ganNvbk9iamVjdFtrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuXG4gICAgc3RhdGljIGRlc2VyaWFsaXplTW9kZWwobW9kZWw6c3RyaW5nLCBqc29uT2JqZWN0OmFueSkge1xuICAgICAgICBpZiAoanNvbk9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICBsZXQgb2JqOmFueSA9IE1vZGVsUmVnaXN0ZXIuSW5zdGFuY2UuaW5zdGFudGlhdGVPYmplY3QobW9kZWwpO1xuICAgICAgICBPYmplY3Qua2V5cyhvYmopLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgbGV0IHByb3BlcnR5TWV0YWRhdGFGbjooSUZpZWxkTWV0YURhdGEpID0+IGFueSA9IChwcm9wZXJ0eU1ldGFkYXRhKT0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcHJvcGVydHlOYW1lID0gcHJvcGVydHlNZXRhZGF0YS5uYW1lIHx8IGtleTtcbiAgICAgICAgICAgICAgICBsZXQgaW5uZXJKc29uID0ganNvbk9iamVjdCA/IGpzb25PYmplY3RbcHJvcGVydHlOYW1lXSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBsZXQgY2xhenogPSBNYXBVdGlscy5nZXRDbGF6eihvYmosIGtleSk7XG4gICAgICAgICAgICAgICAgaWYgKCFqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0pXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIGlmIChNYXBVdGlscy5pc1ByaW1pdGl2ZShjbGF6eikpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb25PYmplY3QgPyBqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0gOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChNYXBVdGlscy5pc0RhdGUobmV3IGNsYXp6KCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uT2JqZWN0ID8gbW9tZW50KGpzb25PYmplY3RbcHJvcGVydHlOYW1lXSxTRVJWRVJfREFURVRJTUVfRk9STUFUKS50b0RhdGUoKTogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBwcm9wZXJ0eU1ldGFkYXRhID0gTWFwVXRpbHMuZ2V0RmllbGRQcm9wZXJ0eShvYmosIGtleSk7XG4gICAgICAgICAgICBpZiAocHJvcGVydHlNZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgIG9ialtrZXldID0gcHJvcGVydHlNZXRhZGF0YUZuKHByb3BlcnR5TWV0YWRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoanNvbk9iamVjdCAmJiBqc29uT2JqZWN0W2tleV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IGpzb25PYmplY3Rba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgIH1cblxuICAgIHN0YXRpYyBzZXJpYWxpemUob2JqZWN0OmFueSk6YW55IHtcbiAgICAgICAgaWYgKG9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4ge307XG4gICAgICAgIGxldCBqc29uT2JqZWN0OmFueSA9IHt9O1xuICAgICAgICBPYmplY3Qua2V5cyhvYmplY3QpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKE1hcFV0aWxzLmlzRGF0ZShvYmplY3Rba2V5XSkpXG4gICAgICAgICAgICAgICAganNvbk9iamVjdFtrZXldID0gbW9tZW50KG9iamVjdFtrZXldKS5mb3JtYXQoU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAganNvbk9iamVjdFtrZXldID0gb2JqZWN0W2tleV07XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4ganNvbk9iamVjdDtcbiAgICB9XG59XG4iXX0=
